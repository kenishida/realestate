# API 濫用・コスト高騰の防止策

Bot やスクリプトがチャット／分析 API を連打し、Gemini 等の API 費用が跳ね上がるリスクへの対策アイデアを整理する。

---

## 現状

- **`/api/chat/rag`** … 認証なしで誰でも POST 可能。会話ID・メッセージを送れば Gemini を叩ける。
- **`/api/analyze`** … Bearer は「会話の所有者紐づけ」用で任意。未ログインでも呼び出し可能。
- **ミドルウェア** … 未導入（`middleware.ts` なし）。レート制限・認証ゲートはなし。
- **Vercel** … 標準の DDoS 緩和はあるが、API 単位のレート制限は自前で必要。

---

## 対策の方向性（優先度の目安）

| 優先度 | 対策 | 効果 | 工数・注意 |
|--------|------|------|------------|
| 高 | レート制限（IP / ユーザー） | 連打の即効抑制 | 中（Redis 等 or 簡易 in-memory） |
| 高 | 認証必須化 | 匿名 Bot を遮断 | 小〜中（既存 Supabase Auth を必須にする） |
| 中 | Bot 検知・CAPTCHA | 自動化リクエストを減らす | 中（Turnstile / reCAPTCHA 等） |
| 中 | 利用量キャップ（ユーザー/日） | 1 ユーザーあたりの暴走を抑える | 中（DB でカウント） |
| 低 | WAF・IP ブロック | 悪質 IP の遮断 | 小（Vercel / Cloudflare 等） |
| 継続 | 監視・アラート | 異常検知と早期対応 | 小（ログ＋メトリクス） |

---

## 1. レート制限（Rate Limiting）

**目的**: 同一クライアント（IP またはユーザー）の短時間あたりのリクエスト数を制限する。

### 1.1 実装パターン

| 方式 | 説明 | メリット | デメリット |
|------|------|----------|------------|
| **Vercel の機能** | Vercel の Rate Limit（Pro 等）があればそれを利用 | 設定のみで済む | プラン依存・細かい制御は限定的 |
| **Upstash Redis** | Serverless 向け Redis。`@upstash/ratelimit` で IP/ユーザー別制限 | 複数インスタンス間で共有・正確 | 外部サービス・コスト |
| **メモリベース** | 各 API 内で `Map` 等に「IP → 回数」を保持 | 追加依存なし・実装が簡単 | サーバーレスではインスタンスごとにカウントが分かれる（過剰許可になりがち） |
| **Next.js の middleware** | `middleware.ts` で `x-forwarded-for` 等を見てレート判定 | 全 API を一括でガード可能 | 判定用ストア（Redis 等）が必要なら上と同様 |

**推奨**: 本番で確実に効かせたいなら **Upstash Redis + `@upstash/ratelimit`**。まずは「同一 IP で 1 分あたり N 回まで」のようなスライディングウィンドウをかける。

### 1.2 制限対象と値の例

- **対象**: `/api/chat/rag`, `/api/analyze`（Gemini を叩くエンドポイント）
- **キー**: `x-forwarded-for` または `x-real-ip` の IP（未設定時は `unknown` でまとめて制限）
- **値の例**: 1 IP あたり「1 分に 20 回」「1 時間に 200 回」など（運用で調整）

---

## 2. 認証の必須化

**目的**: 匿名 Bot を遮断し、利用者を「ログイン済みユーザー」に限定する。

### 2.1 やり方

- **RAG**: `POST /api/chat/rag` の先頭で `Authorization: Bearer <Supabase JWT>` を検証し、`getUser()` でユーザーを取得。未認証なら `401` を返す。
- **Analyze**: 同様に、分析開始前に Bearer 必須にし、未認証なら `401`。

**メリット**: 既存の Supabase Auth だけで完結し、実装が軽い。  
**デメリット**: 「ログインせずにチャットを試す」といった匿名利用はできなくなる。必要なら「未ログインはレート制限を厳しく、ログイン済みは緩く」などの段階制限も検討。

---

## 3. Bot 検知・CAPTCHA

**目的**: ブラウザからの「人間の操作」であることをある程度保証し、単純なスクリプト連打を防ぐ。

### 3.1 方式例

- **Cloudflare Turnstile** … 無料枠あり。CAPTCHA なしで「ボットっぽい」トラフィックをスコアで判定できる。
- **Google reCAPTCHA v3** … スコアベース。スコアが低い場合は API を拒否またはレート制限を強化。
- **hCaptcha** 等 … 同様にフォーム送信前にトークンを取得し、API で検証。

### 3.2 フロー例

1. フロントで「チャット送信」「分析開始」の直前に CAPTCHA トークンを取得。
2. リクエストにトークンを付与（body またはヘッダ）。
3. API 内でトークンを検証し、失敗またはスコア不良なら `429` や `403` を返す。

**注意**: トークンは 1 回限り・有効時間短めにし、同じトークンの再利用は拒否する。

---

## 4. 利用量キャップ（ユーザー/日・月）

**目的**: 1 ユーザー（または 1 会話）あたりの「1 日/月のリクエスト数」に上限を設け、暴走や悪用で費用が膨らむのを抑える。

### 4.1 やり方

- **DB でカウント**: 例として `api_usage` テーブル（`user_id` or `ip_hash`, `date`, `count`）を用意し、RAG/Analyze の成功時に `count` をインクリメント。
- **判定**: リクエスト処理の前に「今日の count が N を超えていないか」を確認。超えていれば `429 Too Many Requests` と「明日までお待ちください」などのメッセージを返す。
- **匿名**: 未ログインの場合は `user_id` の代わりに IP のハッシュなどで同一クライアントとみなす（レート制限と併用）。

**値の例**: 1 ユーザーあたり 1 日 100 回まで、など（Gemini の単価と想定利用者数から逆算）。

---

## 5. インフラ・WAF

- **Vercel**: Pro 以上で Firewall / DDoS 保護のオプションがある場合は、怪しい IP やリージョンのブロックを検討。
- **Cloudflare を前に置く**: ドメインを Cloudflare 経由にし、Bot 管理・レート制限・チャレンジを Cloudflare 側で行う。
- **Google Cloud 側**: Gemini API の利用量アラート・予算アラートを設定し、一定額を超えたら通知・無効化するセーフティネットを用意しておく。

---

## 6. 監視・アラート

- **ログ**: `/api/chat/rag` と `/api/analyze` で「IP / user_id / タイムスタンプ」を構造化ログに出す。Vercel Logs や外部ログ集約で集計。
- **メトリクス**: 時間帯ごとのリクエスト数・エラー数。急増したら Slack 等に通知。
- **ダッシュボード**: 日次/時間単位の「RAG 呼び出し数」「Analyze 呼び出し数」を簡単に把握できるようにする。

---

## 実装の進め方（提案）

1. **即効**: **レート制限**（Upstash または、まずは同一 API 内の簡易メモリ制限）を `/api/chat/rag` と `/api/analyze` にだけでも入れる。
2. **短期**: **認証必須化**。RAG と Analyze を「ログイン済みのみ」にし、匿名 Bot を遮断。
3. **中期**: **利用量キャップ**（ユーザー/日）を DB で導入し、1 ユーザーあたりの上限を設定。
4. **必要に応じて**: **Turnstile / reCAPTCHA** で送信前チェックを追加。
5. **継続**: ログ・メトリクスとアラートで異常なトラフィックを検知し、上記をチューニング。

---

## 参考

- [Upstash Ratelimit](https://upstash.com/docs/redis/sdks/ratelimit-ts/overview)
- [Vercel – Rate Limiting](https://vercel.com/docs/security/rate-limiting)（プランによる）
- [Cloudflare Turnstile](https://www.cloudflare.com/products/turnstile/)
- [Next.js Middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)
