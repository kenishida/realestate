# チャットの自由度を高める実装提案

## 現状の問題

- `/chat/[slug]` では **by-path API** で物件・分析・メッセージを取得しているため、**既に物件URLが紐づいたチャット**である。
- しかし `handleSendMessage` では「自由入力」時に **常に** 「物件URLを入力していただければ、投資判断を行います。」と固定返信している。
- 理由: 「次の一手」を **会話の文脈（いま何が揃っているか）** ではなく、**セッション中のフラグ**（`waitingForPurpose`）だけで決めているため。  
  - `waitingForPurpose` は「このセッションでURLを分析した直後」にしか `true` にならない。  
  - スラグで開いたチャットは「物件あり・投資目的なし」の状態でも、ロード時に `waitingForPurpose` を復元していないため、挨拶などに一律「URLを入力して」と返してしまう。

## 必要な考え方

**「会話状態」を「いま持っているデータ」から導出する。**

- 物件が決まっているか → `propertyData?.property` の有無
- 投資目的が決まっているか → `propertyData?.analysis?.investment_purpose` の有無

この2つで「URLを聞く / 投資目的を聞く / 両方揃っている」を切り替え、返答内容を変える。

---

## 案1: クライアント側で状態を導出し、テンプレートで返す（推奨・最小実装）

### 概要

- 自由入力（URLでない & 今回のメッセージで目的回答として扱わない）のとき、**クライアントで** `propertyData` から状態を計算する。
- 状態に応じて **固定テンプレート** で返す。挨拶っぽい入力のときは、返答の先頭に「こんにちは。」などを付与する。

### 状態と返答の対応

| 状態 | 返答の内容 |
|------|------------|
| 物件なし | 挨拶なら「こんにちは。」＋「物件URLを入力していただければ、投資判断を行います。」 |
| 物件あり・投資目的なし | 挨拶なら「こんにちは。」＋「この物件について、投資目的を教えてください。」＋選択肢。**この返信のあと `waitingForPurpose = true` にし、次のユーザー入力を投資目的として扱う**。 |
| 物件あり・投資目的あり | 挨拶なら「こんにちは。」＋「この物件について、他に知りたいことはありますか？」など。 |

### 挨拶検知（任意）

- ユーザーメッセージが短い（例: 20字以内）かつ、「こんにちは」「おはよう」「はい」などを含む場合は「挨拶」とみなし、返答の先頭に「こんにちは。」を付ける。

### 変更箇所

- **`app/chat/[slug]/page.tsx`** の `handleSendMessage` 内、`else` ブロック（「URLでもなく、waitingForPurpose の回答でもない」とき）のみ。
- ここで `propertyData` から `hasProperty` / `hasPurpose` を算出し、上記3パターンのいずれかのテンプレートで `content` を組み立てる。投資目的を聞くパターンのときだけ `setWaitingForPurpose(true)` を呼ぶ。
- **新規APIは不要。**

### メリット・デメリット

- **メリット**: 実装が軽い、レイテンシ・コストなし、挙動が読みやすい。
- **デメリット**: 言い回しはテンプレートのまま。本当に「自由な言い回し」で返すには案2が必要。

---

## 案2: LLM で返答文を生成する（自然な対話）

### 概要

- 自由入力時に **API を1本用意** し、**会話履歴＋現在の状態（物件あり/なし、投資目的あり/なし）** を渡す。
- システムプロンプトで「物件が未設定ならURLを、投資目的が未設定なら目的を聞く。挨拶には応答しつつ、不足情報を促す。物件評価に必要な範囲で答える」と指定し、LLM に **返答文だけ** 生成させる。
- フロントはその返答をそのまま assistant メッセージとして表示する。URL送信・目的送信時の既存API（analyze / analyze-purpose）はそのまま使う。

### 変更箇所

- 新規: **`app/api/chat/reply/route.ts`**（または類似）  
  - 入力: `{ messages, hasProperty, hasPurpose }`  
  - 出力: `{ content: string }`
- **`app/chat/[slug]/page.tsx`**: 自由入力時に上記APIを呼び、返ってきた `content` をメッセージに使う。必要なら「投資目的を聞いた返答」のときは `setWaitingForPurpose(true)` を、LLMの出力ではなく「目的を聞いた」と判定するロジック（キーワードやフラグ）で行う。

### メリット・デメリット

- **メリット**: 挨拶や言い回しに柔軟に対応できる。将来「地域相場」などに言及するときもプロンプト拡張で対応しやすい。
- **デメリット**: レイテンシ・コスト、プロンプト設計・テストが必要。

---

## 推奨

- **まずは案1** で「やりとりを踏まえて、URL／投資目的のどちらを聞くか」を正しく切り替え、挨拶時には「こんにちは。」を付けて返すようにする。
- そのうえで、言い回しや対話の自然さをさらに上げたい場合に **案2** を検討する、という段階的な進め方がよい。

---

## 補足: スラグで開いたチャットで「投資目的なし」の復元

- 案1では「物件あり・投資目的なし」のとき、返信と同時に `setWaitingForPurpose(true)` にするため、**ロード時に `waitingForPurpose` を復元する必要はない**。ユーザーが挨拶などで一度返信を貰った時点で「投資目的を教えてください」と出し、次の入力が目的として扱われる。
- もし「ページを開いた時点で、既に目的未入力なら最初から目的入力プロンプトを表示したい」という要件があれば、`loadConversationBySlug` の結果で `property && !analysis?.investment_purpose` のとき `setWaitingForPurpose(true)` を呼ぶ実装を追加すればよい。
