# チャットサービスの仕組み

## 概要

このチャットは **RAG（Retrieval-Augmented Generation）は使っていません**。  
「ユーザー発話の種類」に応じた **ルールベースの分岐** と、**限定的なAPI呼び出し** で動いています。

## アーキテクチャ

### 1. 応答の決め方（フロント）

チャットは次の3つの入口で実装されています。

| ページ | ファイル | 役割 |
|--------|----------|------|
| トップ | `app/page.tsx` | 新規会話の入口。URL送信で分析開始。 |
| チャット（スラグ） | `app/chat/[slug]/page.tsx` | 会話履歴を読み込み、同一チャット内で継続。 |
| 物件詳細 | `app/property/[id]/page.tsx` | 物件ID固定。その物件の分析・収支のみ。 |

いずれも **`handleSendMessage(content)`** 内で、次のような **if / else if の順番** で処理しています。

1. **URL かどうか** → 物件URLなら `/api/analyze` を呼び、投資判断を取得し、続けて「投資目的を教えて」と出す。
2. **想定家賃待ちか**（`waitingForRent`）→ 数字なら収支シミュレーション計算 or API 保存。
3. **「収支シミュレーション／利回り」要求か**（`isCashflowRequest` / `isYieldRequest`）→ 物件価格があれば「想定家賃を教えて」と返す。
4. **投資目的待ちか**（`waitingForPurpose`）→ テキストを「投資目的」として `/api/analyze-purpose` に渡す。
5. **上記のどれでもない** → 定型の短文のみ返す（「投資目的を教えて」「他に知りたいことは？」など）。

つまり、「意図の判定」は **キーワードと状態フラグ** だけで行っており、LLMによる意図分類や検索はしていません。

### 2. バックエンドでLLMを使う箇所

- **`/api/analyze`**  
  物件URL → HTML取得・スクレイプ → **Gemini** で投資判断テキストを生成。  
  入力は「物件概要」などの構造化データ。会話履歴は渡していない。
- **`/api/analyze-purpose`**  
  `propertyId` / `analysisId` / `purpose`（文字列）を受け取り、**Gemini** で「その投資目的に特化した分析」を生成。  
  入力は既存の投資判断サマリ＋物件情報＋`purpose` のみ。会話文脈は渡していない。

どちらも **「今の会話の直前発話」を解釈するのではなく、「APIに渡されたパラメータ」だけ** で答えを出しています。

### 3. RAGがないことの意味

- **物件情報・投資判断・収支などは**  
  フロントが持っている `propertyData` / `analysis` / 収支シミュレーション結果などに限られ、  
  それらを「検索してLLMに渡す」ような仕組みはありません。
- **自由な質問**（「この物件の利回りは？」「周辺の相場は？」など）には、  
  現状は **定型の短文** か、**意図が「投資目的」と誤解されたときの analyze-purpose の結果** しか返せません。
- そのため、**順番を間違えると誤動作**します。  
  例: 投資目的をまだ答えていない状態で「収支シミュレーションを出して」と言うと、  
  トップページでは「収支シミュレーション」用の分岐が **投資目的の分岐より後** にないため、  
  `waitingForPurpose` が先にマッチし、`purpose="収支シミュレーションを出して"` として analyze-purpose が呼ばれ、  
  「投資目的に特化した分析」として不自然な回答になります。

## まとめ

| 項目 | 内容 |
|------|------|
| RAG | なし。物件・分析の検索・ retrieval は行っていない。 |
| 意図判定 | キーワード＋状態（`waitingForPurpose` / `waitingForRent`）の if/else。 |
| LLM利用 | `/api/analyze`（投資判断生成）と `/api/analyze-purpose`（投資目的別分析）の2種類のみ。 |
| 会話文脈 | APIには渡していない。フロントの状態だけで分岐。 |
| ハルシネーション | 自由入力は定型文のみ返すため、LLMには流れない。誤るのは「意図の取り違え」（例: 収支→投資目的）による不適切な analyze-purpose の結果。 |

柔軟に対応するには、  
(1) **「収支シミュレーション／利回り」などの意図を、投資目的より先に判定する**（分岐順の修正）、  
(2) 必要なら **「意図が不明なときは analyze-purpose を呼ばず、定型文だけ返す」** といった制御が有効です。
